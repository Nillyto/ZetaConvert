<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ZetaConvert ‚Äî Conversor online</title>
    <meta name="description" content="ZetaConvert: convert√≠ im√°genes (JPG, PNG, WEBP, BMP, TIFF, GIF) con fondo transparente opcional. R√°pido, claro y profesional." />
    <link rel="canonical" href="https://zetaconvert.online/" />
    <meta name="theme-color" content="#e1192a" />
    <meta property="og:title" content="ZetaConvert ‚Äî Conversor online" />
    <meta property="og:description" content="Convert√≠ im√°genes con barra de progreso y fondo transparente. Blanco/negro/rojo, r√°pido y prolijo." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://zetaconvert.online/" />
    <link rel="icon" href="/assets/logo.svg" type="image/svg+xml" />
  
    <!-- üëá estas dos l√≠neas son la clave -->
    <link rel="preload" href="/assets/css/styles.css" as="style">
    <link rel="stylesheet" href="/assets/css/styles.css">
  
    <noscript><meta http-equiv="refresh" content="0;url=/no-js.html"></noscript>
  </head>
  
<body data-theme="auto">
  <!-- Skip link -->
  <a href="#main" class="skip-link" data-animate="focus">Saltar al contenido</a>

  <!-- Header / Topbar -->
  <header role="banner" class="header">
    <nav class="nav" aria-label="Principal">
      <a class="brand" href="/" data-link aria-label="ZetaConvert Home">
        <img src="/assets/logo.svg" alt="" width="28" height="28" />
        <span class="brand-name">ZetaConvert</span>
      </a>

      <ul class="nav-links" role="menubar">
        <li role="none"><a role="menuitem" href="/" data-link data-i18n="nav_home" aria-current="page">Inicio</a></li>
        <li role="none"><a role="menuitem" href="/jpg-to-png" data-link>JPG‚ÜíPNG</a></li>
        <li role="none"><a role="menuitem" href="/png-to-jpg" data-link>PNG‚ÜíJPG</a></li>
        <li role="none"><a role="menuitem" href="/webp-to-jpg" data-link>WEBP‚ÜíJPG</a></li>
        <li role="none"><a role="menuitem" href="/bmp-to-png" data-link>BMP‚ÜíPNG</a></li>
      </ul>

      <div class="actions">
        <!-- Idioma -->
        <label class="visually-hidden" for="lang">Idioma</label>
        <select id="lang" aria-label="Idioma / Language" class="compact">
          <option value="es" selected>ES</option>
          <option value="en">EN</option>
        </select>
        <!-- Tema -->
        <label class="visually-hidden" for="theme">Tema</label>
        <select id="theme" aria-label="Tema" class="compact">
          <option value="auto" selected data-i18n="theme_auto">Auto</option>
          <option value="light" data-i18n="theme_light">Claro</option>
          <option value="dark" data-i18n="theme_dark">Oscuro</option>
        </select>
      </div>
    </nav>
  </header>

  <!-- Main -->
  <main id="main" tabindex="-1">
    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-title">
      <h1 id="hero-title" data-i18n="hero_title">Convert√≠ archivos sin complicarte</h1>
      <p class="muted" data-i18n="hero_sub">Eleg√≠ la categor√≠a, el formato destino y listo. R√°pido, claro y profesional.</p>
      <div class="quick-routes" role="navigation" aria-label="Rutas r√°pidas">
        <a class="chip" href="/jpg-to-png" data-link>JPG‚ÜíPNG</a>
        <a class="chip" href="/png-to-jpg" data-link>PNG‚ÜíJPG</a>
        <a class="chip" href="/webp-to-jpg" data-link>WEBP‚ÜíJPG</a>
        <a class="chip" href="/bmp-to-png" data-link>BMP‚ÜíPNG</a>
      </div>
    </section>

    <!-- TABS CATEGORIES -->
    <nav class="tabs" role="tablist" aria-label="Categor√≠as">
      <button class="tab" role="tab" aria-selected="true" aria-controls="tab-images" id="t-images" data-i18n="tab_images">Im√°genes</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-text" id="t-text" data-i18n="tab_text">Texto</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-extras" id="t-extras" data-i18n="tab_extras">Extras</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="tab-3d" id="t-3d" data-i18n="tab_3d">3D</button>
    </nav>

    <!-- PANEL: IM√ÅGENES -->
    <section class="panel" id="tab-images" role="tabpanel" aria-labelledby="t-images">
      <header class="panel-head">
        <h2 data-i18n="images_title">Im√°genes</h2>
        <p class="muted" data-i18n="images_desc">Formatos de entrada: JPG, PNG, WEBP, BMP, TIFF, GIF (1¬™ frame). L√≠mite 10 MB.</p>
      </header>

      <!-- ROUTE TITLE (changes with /jpg-to-png etc.) -->
      <div class="route-title mono" id="routeTitle" aria-live="polite"></div>

      <form id="imgForm" class="form" novalidate>
        <div class="grid2">
          <div>
            <label for="file" data-i18n="label_file">Archivo</label>
            <input id="file" type="file" accept="image/*" required />
            <div id="fileInfo" class="hint mono" aria-live="polite" data-i18n="no_file">No hay archivo</div>
          </div>

          <div>
            <label for="target" data-i18n="label_target">Convertir a</label>
            <select id="target" required disabled>
              <option value="">{select}</option>
            </select>
            <p class="note" data-i18n="note_png">Para <strong>fondo transparente</strong>, eleg√≠ <b>PNG</b> y activ√° ‚ÄúEliminar fondo‚Äù.</p>
          </div>
        </div>

        <details class="adv" id="advOptions">
          <summary data-i18n="advanced_opts">Opciones avanzadas</summary>
          <div class="grid2">
            <div class="inline">
              <input id="removeBg" type="checkbox" disabled />
              <label for="removeBg" data-i18n="remove_bg">Eliminar fondo (solo PNG)</label>
            </div>
            <div>
              <label for="tolerance" data-i18n="tolerance">Tolerancia</label>
              <input id="tolerance" type="range" min="0" max="100" value="35" disabled />
              <div class="hint mono"><span data-i18n="value">Valor</span>: <span id="tolVal">35</span></div>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="mode" data-i18n="mode">Modo</label>
              <select id="mode" disabled>
                <option value="auto" selected data-i18n="mode_auto">Auto (color del borde)</option>
                <option value="color" data-i18n="mode_color">Color manual</option>
              </select>
            </div>
            <div>
              <label for="color" data-i18n="bg_color">Color del fondo (manual)</label>
              <input id="color" type="color" value="#ffffff" disabled />
              <div class="hint" data-i18n="pick_tip">Con ‚ÄúColor manual‚Äù, hac√© clic en la previsualizaci√≥n para tomar el color exacto.</div>
            </div>
          </div>
        </details>

        <div class="preview-wrap">
          <canvas id="preview" aria-label="Previsualizaci√≥n"></canvas>
        </div>

        <div class="grid2">
          <button id="convertBtn" type="submit" disabled data-animate="press" data-i18n="btn_convert">Convertir</button>
          <button id="downloadBtn" type="button" disabled data-animate="press" data-i18n="btn_download">Descargar</button>
        </div>

        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-live="polite" aria-label="Progreso">
          <div class="bar" id="bar" style="width:0%"></div>
        </div>
        <div class="hint mono" id="status" aria-live="polite" data-i18n="status_wait">Esperando archivo‚Ä¶</div>
      </form>
    </section>

    <!-- PANEL: TEXTO -->
    <section class="panel" id="tab-text" role="tabpanel" aria-labelledby="t-text" hidden>
      <h2 data-i18n="text_title">Texto</h2>
      <p class="muted" data-i18n="text_desc">Pr√≥ximamente: PDF ‚Üî DOCX, TXT ‚Üî PDF, subt√≠tulos.</p>
      <p class="note" data-i18n="text_note">Si ten√©s un caso puntual, contanos y lo priorizamos.</p>
    </section>

    <!-- PANEL: EXTRAS -->
    <section class="panel" id="tab-extras" role="tabpanel" aria-labelledby="t-extras" hidden>
      <h2 data-i18n="extras_title">Extras</h2>
      <p class="muted" data-i18n="extras_desc">Pr√≥ximamente: comprimir, redimensionar por lote, metadatos.</p>
    </section>

    <!-- PANEL: 3D -->
    <section class="panel" id="tab-3d" role="tabpanel" aria-labelledby="t-3d" hidden>
      <h2 data-i18n="three_title">3D</h2>
      <p class="muted" data-i18n="three_desc">Pr√≥ximamente: OBJ ‚Üî GLB/GLTF, STL, FBX.</p>
    </section>
  </main>

  <!-- Footer -->
  <footer role="contentinfo" class="footer">
    <div class="foot">
      <span class="mono">¬© <span id="year"></span> ZetaConvert</span>
      <nav aria-label="Legal">
        <a href="/terms" data-link data-i18n="terms">T√©rminos</a> ¬∑
        <a href="/privacy" data-link data-i18n="privacy">Privacidad</a> ¬∑
        <a href="mailto:hola@zetaconvert.online" data-i18n="contact">Contacto</a>
      </nav>
    </div>
  </footer>

  <!-- ============ SCRIPT (router, i18n, theme, conversion) ============ -->
  <script>
    // ===== Backend URL (ajust√° si cambia) =====
    const BACKEND_URL = "https://zetaconvert-backend.onrender.com";

    // ===== Utilidades =====
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    const preferDark = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    // ===== Estado global =====
    const state = {
      lang: localStorage.getItem('zc_lang') || (navigator.language || 'es').slice(0,2),
      theme: localStorage.getItem('zc_theme') || 'auto',
      lastBlobUrl: null,
      outName: 'convertido.png',
      imgObj: null
    };

    // ===== i18n =====
    const I18N = {
      es: {
        nav_home: "Inicio",
        theme_auto: "Auto", theme_light: "Claro", theme_dark: "Oscuro",
        hero_title: "Convert√≠ archivos sin complicarte",
        hero_sub: "Eleg√≠ la categor√≠a, el formato destino y listo. R√°pido, claro y profesional.",
        tab_images: "Im√°genes", tab_text: "Texto", tab_extras: "Extras", tab_3d: "3D",
        images_title: "Im√°genes",
        images_desc: "Formatos de entrada: JPG, PNG, WEBP, BMP, TIFF, GIF (1¬™ frame). L√≠mite 10 MB.",
        label_file: "Archivo", label_target: "Convertir a",
        note_png: "Para <strong>fondo transparente</strong>, eleg√≠ <b>PNG</b> y activ√° ‚ÄúEliminar fondo‚Äù.",
        advanced_opts: "Opciones avanzadas",
        remove_bg: "Eliminar fondo (solo PNG)",
        tolerance: "Tolerancia",
        value: "Valor",
        mode: "Modo", mode_auto: "Auto (color del borde)", mode_color: "Color manual",
        bg_color: "Color del fondo (manual)",
        pick_tip: "Con ‚ÄúColor manual‚Äù, hac√© clic en la previsualizaci√≥n para tomar el color exacto.",
        btn_convert: "Convertir", btn_download: "Descargar",
        status_wait: "Esperando archivo‚Ä¶",
        terms: "T√©rminos", privacy: "Privacidad", contact: "Contacto"
      },
      en: {
        nav_home: "Home",
        theme_auto: "Auto", theme_light: "Light", theme_dark: "Dark",
        hero_title: "Convert files, no fuss",
        hero_sub: "Pick a category, pick a target format, done. Fast, clear, professional.",
        tab_images: "Images", tab_text: "Text", tab_extras: "Extras", tab_3d: "3D",
        images_title: "Images",
        images_desc: "Input formats: JPG, PNG, WEBP, BMP, TIFF, GIF (first frame). Limit 10 MB.",
        label_file: "File", label_target: "Convert to",
        note_png: "For <strong>transparent background</strong>, choose <b>PNG</b> and enable ‚ÄúRemove background‚Äù.",
        advanced_opts: "Advanced options",
        remove_bg: "Remove background (PNG only)",
        tolerance: "Tolerance",
        value: "Value",
        mode: "Mode", mode_auto: "Auto (edge color)", mode_color: "Manual color",
        bg_color: "Background color (manual)",
        pick_tip: "With ‚ÄúManual color‚Äù, click on the preview to pick the exact color.",
        btn_convert: "Convert", btn_download: "Download",
        status_wait: "Waiting for file‚Ä¶",
        terms: "Terms", privacy: "Privacy", contact: "Contact"
      }
    };

    function applyI18n() {
      const dict = I18N[state.lang] || I18N.es;
      document.documentElement.lang = state.lang;
      $$("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (!key) return;
        const raw = dict[key] || el.textContent;
        // admite HTML simple (ej: <strong>)
        el.innerHTML = raw;
      });
      // options en selects (tema)
      $("#theme").querySelectorAll("option").forEach(opt=>{
        const k = opt.getAttribute("data-i18n");
        if (k && dict[k]) opt.textContent = dict[k];
      });
      // placeholder select target
      const sel = $("#target");
      if (sel && sel.options.length && sel.value === "") {
        sel.options[0].textContent = (state.lang==='en' ? "Choose a format‚Ä¶" : "Eleg√≠ un formato‚Ä¶");
      }
      document.title = (state.lang==='en' ? "ZetaConvert ‚Äî Online converter" : "ZetaConvert ‚Äî Conversor online");
      const metaDesc = document.querySelector('meta[name="description"]');
      if (metaDesc) metaDesc.setAttribute('content', state.lang==='en'
        ? "ZetaConvert: convert images (JPG, PNG, WEBP, BMP, TIFF, GIF) with optional transparent background."
        : "ZetaConvert: convert√≠ im√°genes (JPG, PNG, WEBP, BMP, TIFF, GIF) con fondo transparente opcional.");
    }

    // ===== Tema =====
    function applyTheme() {
      const theme = state.theme;
      document.body.dataset.theme = theme;
      if (theme === 'auto') {
        document.documentElement.classList.toggle('dark', preferDark());
      } else {
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }
    }
    (function attachPrefersDarkListener(){
  if (!window.matchMedia) return;
  const mql = window.matchMedia('(prefers-color-scheme: dark)');
  const handler = () => { if (state.theme === 'auto') applyTheme(); };
  if (mql.addEventListener) {
    mql.addEventListener('change', handler);
  } else if (mql.addListener) {
    // Safari viejos / Android WebView
    mql.addListener(handler);
  }
})();


    $("#lang").addEventListener("change", (e)=>{
      state.lang = e.target.value;
      localStorage.setItem('zc_lang', state.lang);
      applyI18n();
      updateRouteTitle();
      updateNavCurrent();
    });
    $("#theme").addEventListener("change", (e)=>{
      state.theme = e.target.value;
      localStorage.setItem('zc_theme', state.theme);
      applyTheme();
    });

    // ===== Router (History API, rutas limpias) =====
    const routes = [
      { path: /^\/$/,            preset: null,           title: {es:"Inicio", en:"Home"} },
      { path: /^\/jpg-to-png\/?$/,   preset: {from:[".jpg",".jpeg"], to:"png"},  title:{es:"JPG ‚Üí PNG", en:"JPG ‚Üí PNG"} },
      { path: /^\/png-to-jpg\/?$/,   preset: {from:[".png"],         to:"jpg"},  title:{es:"PNG ‚Üí JPG", en:"PNG ‚Üí JPG"} },
      { path: /^\/webp-to-jpg\/?$/,  preset: {from:[".webp"],        to:"jpg"},  title:{es:"WEBP ‚Üí JPG", en:"WEBP ‚Üí JPG"} },
      { path: /^\/bmp-to-png\/?$/,   preset: {from:[".bmp"],         to:"png"},  title:{es:"BMP ‚Üí PNG", en:"BMP ‚Üí PNG"} },
      { path: /^\/terms\/?$/,    preset: "terms",        title: {es:"T√©rminos", en:"Terms"} },
      { path: /^\/privacy\/?$/,  preset: "privacy",      title: {es:"Privacidad", en:"Privacy"} },
    ];

    function navigate(pathname, replace=false) {
      const route = routes.find(r => r.path.test(pathname)) || routes[0];
      if (!replace) history.pushState({}, "", pathname);
      applyRoute(route);
      updateNavCurrent();
      updateRouteTitle(route);
    }
    function onLinkClick(e) {
      const a = e.target.closest("a[data-link]");
      if (a && a.href.startsWith(location.origin)) {
        e.preventDefault();
        navigate(new URL(a.href).pathname);
      }
    }
    document.addEventListener("click", onLinkClick);
    window.addEventListener("popstate", ()=> applyRoute(routes.find(r=>r.path.test(location.pathname))||routes[0]));

    function updateNavCurrent() {
      $$(".nav-links a[data-link]").forEach(a=>{
        a.setAttribute("aria-current", a.getAttribute("href")===location.pathname ? "page" : "false");
      });
    }

    function updateRouteTitle(route) {
      route = route || routes.find(r=>r.path.test(location.pathname)) || routes[0];
      const el = $("#routeTitle");
      if (!el) return;
      if (route.preset && route.preset !== 'terms' && route.preset !== 'privacy') {
        el.textContent = (state.lang==='en' ? "Route: " : "Ruta: ") + (route.title[state.lang] || "");
      } else {
        el.textContent = "";
      }
      const t = route.title ? route.title[state.lang] : null;
      if (t) document.title = `ZetaConvert ‚Äî ${t}`;
    }

    function applyRoute(route) {
      // mostrar el panel de im√°genes como principal (otras son placeholders por ahora)
      $("#t-images").setAttribute("aria-selected","true");
      $("#tab-images").hidden = false;
      $("#t-text").setAttribute("aria-selected","false");
      $("#t-extras").setAttribute("aria-selected","false");
      $("#t-3d").setAttribute("aria-selected","false");
      $("#tab-text").hidden = true; $("#tab-extras").hidden = true; $("#tab-3d").hidden = true;

      // presets
      const targetSel = $("#target");
      if (route.preset && typeof route.preset === "object") {
        // forzar opciones sugeridas
        populateTarget(route.preset.from);
        // preseleccionar target deseado
        targetSel.value = route.preset.to;
        targetSel.dispatchEvent(new Event('change'));
      } else {
        populateTarget(); // normal (todas)
      }

      if (route.preset === "terms" || route.preset === "privacy") {
        // Podr√≠as mostrar contenido legal aqu√≠; por ahora navegamos al home
        navigate("/", true);
      }
    }

    // ===== Tabs switching (visual) =====
    $$(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        $$(".tab").forEach(b=>b.setAttribute("aria-selected", b===btn ? "true":"false"));
        const panels = ["#tab-images","#tab-text","#tab-extras","#tab-3d"];
        panels.forEach(sel=>{
          const el = $(sel); if (!el) return;
          el.hidden = ("#"+el.id) !== ("#"+btn.getAttribute("aria-controls"));
        });
      });
    });

    // ===== Conversor Im√°genes =====
    const SUGGESTIONS = {
      ".jpg":  ["png","webp","bmp","tiff"],
      ".jpeg": ["png","webp","bmp","tiff"],
      ".png":  ["jpg","webp","bmp","tiff"],
      ".webp": ["jpg","png","bmp","tiff"],
      ".bmp":  ["jpg","png","webp","tiff"],
      ".tif":  ["jpg","png","webp","bmp"],
      ".tiff": ["jpg","png","webp","bmp"],
      ".gif":  ["png","webp","jpg"]
    };
    const ALL = ["png","jpg","webp","bmp","tiff"];

    function extOf(n){ n=(n||"").toLowerCase(); const i=n.lastIndexOf("."); return i>=0?n.slice(i):"" }

    const fileInput = $("#file");
    const fileInfo  = $("#fileInfo");
    const removeBg  = $("#removeBg");
    const tolerance = $("#tolerance");
    const tolVal    = $("#tolVal");
    const modeSel   = $("#mode");
    const colorInp  = $("#color");
    const convertBtn= $("#convertBtn");
    const downloadBtn=$("#downloadBtn");
    const bar       = $("#bar");
    const statusEl  = $("#status");
    const canvas    = $("#preview");
    const ctx       = canvas.getContext("2d");

    function setProgress(p,t){
      const pct = Math.max(0,Math.min(100,p));
      bar.style.width = pct + "%";
      $(".progress").setAttribute("aria-valuenow", String(pct));
      if (t) statusEl.textContent = t;
    }
    function drawPreview(file){
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        const maxW = canvas.clientWidth || 720;
        const scale = Math.min(maxW / img.width, 1);
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        state.imgObj = img;
        URL.revokeObjectURL(url);
      };
      img.src = url;
    }
    canvas.addEventListener("click", (e) => {
      if (!state.imgObj || modeSel.value !== "color") return;
      const r = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - r.left) * (canvas.width / r.width));
      const y = Math.floor((e.clientY - r.top) * (canvas.height / r.height));
      const d = ctx.getImageData(x, y, 1, 1).data;
      const hex = "#" + [d[0], d[1], d[2]].map(v => v.toString(16).padStart(2,'0')).join("");
      colorInp.value = hex;
      colorInp.dispatchEvent(new Event('input'));
    });

    tolerance.addEventListener("input", ()=> tolVal.textContent = tolerance.value);

    fileInput.addEventListener("change", ()=>{
      downloadBtn.disabled = true;
      if (state.lastBlobUrl) { URL.revokeObjectURL(state.lastBlobUrl); state.lastBlobUrl = null; }
      const f = fileInput.files[0];
      if (!f){
        fileInfo.textContent = (state.lang==='en' ? "No file" : "No hay archivo");
        $("#target").disabled = true; $("#target").innerHTML = `<option value="">${state.lang==='en'?"Choose a format‚Ä¶":"Eleg√≠ un formato‚Ä¶"}</option>`;
        convertBtn.disabled = true; removeBg.disabled = true; removeBg.checked = false;
        tolerance.disabled = true; modeSel.disabled = true; colorInp.disabled = true;
        setProgress(0, state.lang==='en' ? "Waiting for file‚Ä¶" : "Esperando archivo‚Ä¶");
        ctx.clearRect(0,0,canvas.width,canvas.height); state.imgObj = null;
        return;
      }
      drawPreview(f);
      fileInfo.textContent = `${f.name} ¬∑ ${(f.size/1024/1024).toFixed(2)} MB ¬∑ ${f.type || (state.lang==='en'?'no mimetype':'sin mimetype')}`;
      const opts = SUGGESTIONS[extOf(f.name)] || ALL;
      populateTarget(null, opts);
      $("#target").disabled = false;
      convertBtn.disabled = true;
      removeBg.disabled = true; removeBg.checked = false;
      tolerance.disabled = true; modeSel.disabled = true; colorInp.disabled = true;
      setProgress(0, state.lang==='en' ? "Pick a target format‚Ä¶" : "Formato destino pendiente‚Ä¶");
    });

    $("#target").addEventListener("change", ()=>{
      const f = fileInput.files[0];
      const tgt = $("#target").value;
      const png = tgt === "png";
      removeBg.disabled = !png; tolerance.disabled = !png; modeSel.disabled = !png;
      colorInp.disabled = !png || modeSel.value !== "color";
      if (!png) removeBg.checked = false;
      convertBtn.disabled = !(f && tgt);
      if (!convertBtn.disabled) setProgress(0, state.lang==='en' ? "Ready to convert" : "Listo para convertir");
    });

    modeSel.addEventListener("change", ()=> {
      colorInp.disabled = (modeSel.value !== "color") || removeBg.disabled || !removeBg.checked;
    });
    removeBg.addEventListener("change", ()=> {
      const on = removeBg.checked && ($("#target").value === 'png');
      tolerance.disabled = !on; modeSel.disabled = !on; colorInp.disabled = !on || modeSel.value!=='color';
    });

    $("#imgForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const f = fileInput.files[0]; const target = $("#target").value;
      if (!f || !target) return;

      downloadBtn.disabled = true;
      if (state.lastBlobUrl) { URL.revokeObjectURL(state.lastBlobUrl); state.lastBlobUrl = null; }

      const base = f.name.includes(".") ? f.name.slice(0, f.name.lastIndexOf(".")) : "convertido";
      state.outName = `${base}.${target}`;

      const xhr = new XMLHttpRequest();
      xhr.open("POST", `${BACKEND_URL}/convert`);
      xhr.responseType = "blob";

      xhr.upload.onprogress = (ev) => {
        if (ev.lengthComputable) {
          const pct = Math.round((ev.loaded/ev.total)*60);
          setProgress(pct, (state.lang==='en' ? "Uploading‚Ä¶ " : "Subiendo‚Ä¶ ") + pct + "%");
        } else setProgress(20, state.lang==='en' ? "Uploading‚Ä¶" : "Subiendo‚Ä¶");
      };
      xhr.onprogress = (ev) => {
        if (ev.lengthComputable) {
          const pct = 60 + Math.round((ev.loaded/ev.total)*40);
          setProgress(pct, (state.lang==='en' ? "Downloading‚Ä¶ " : "Descargando‚Ä¶ ") + pct + "%");
        } else setProgress(90, state.lang==='en' ? "Downloading‚Ä¶" : "Descargando‚Ä¶");
      };
      xhr.onload = () => {
        if (xhr.status>=200 && xhr.status<300){
          setProgress(100, state.lang==='en' ? "Done ‚úîÔ∏è" : "Listo ‚úîÔ∏è");
          state.lastBlobUrl = URL.createObjectURL(xhr.response);
          downloadBtn.disabled = false;
          // micro-anim
          convertBtn.setAttribute("data-success","1");
          setTimeout(()=>convertBtn.removeAttribute("data-success"),600);
        } else {
          const r = new FileReader();
          r.onload = ()=> alert(`Error ${xhr.status}: ${r.result}`);
          r.readAsText(xhr.response);
          setProgress(0, state.lang==='en' ? "Error" : "Error");
          downloadBtn.disabled = true;
        }
      };
      xhr.onerror = () => {
        setProgress(0, state.lang==='en' ? "Network error" : "Error de red");
        alert(state.lang==='en' ? "Could not reach the server." : "No se pudo conectar al servidor.");
      };

      const fd = new FormData();
      fd.append("file", f);
      fd.append("target", target);
      if (target==='png' && removeBg.checked){
        fd.append("remove_bg","1");
        fd.append("tolerance", String(tolerance.value));
        fd.append("remove_bg_mode", modeSel.value);
        if (modeSel.value==='color') fd.append("ref_color", colorInp.value);
      }

      setProgress(5, state.lang==='en' ? "Preparing‚Ä¶" : "Preparando‚Ä¶");
      xhr.send(fd);
    });

    $("#downloadBtn").addEventListener("click", ()=>{
      if (!state.lastBlobUrl) return;
      const a = document.createElement("a");
      a.href = state.lastBlobUrl;
      a.download = state.outName;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // populate target helper
    function populateTarget(fromExts=null, explicitList=null){
      const sel = $("#target");
      const list = explicitList || ["png","jpg","webp","bmp","tiff"];
      sel.innerHTML = `<option value="">${state.lang==='en'?"Choose a format‚Ä¶":"Eleg√≠ un formato‚Ä¶"}</option>`;
      list.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o; opt.textContent = o.toUpperCase();
        sel.appendChild(opt);
      });
      sel.disabled = false;
    }

    // ===== Tabs click animate (micro) =====
    $$(".tab").forEach(b=>{
      b.addEventListener("click", ()=>{
        b.classList.add("pulse");
        setTimeout(()=>b.classList.remove("pulse"),220);
      });
    });

    // ===== Init =====
    (function init(){
      // a√±o footer
      $("#year").textContent = new Date().getFullYear();
      // idioma
      if (!['es','en'].includes(state.lang)) state.lang='es';
      $("#lang").value = state.lang;
      applyI18n();
      // tema
      $("#theme").value = state.theme;
      applyTheme();
      // eventos nav
      document.addEventListener("keydown",(e)=>{
        if (e.key==="Escape") document.activeElement && document.activeElement.blur();
      });
      // route first load
      const current = routes.find(r=>r.path.test(location.pathname)) || routes[0];
      applyRoute(current); updateRouteTitle(current); updateNavCurrent();
      // set aria on hero quick routes if matches
      $$(".quick-routes a").forEach(a=>{
        if (a.getAttribute("href")===location.pathname) a.setAttribute("aria-current","page");
      });
    })();
  </script>
</body>
</html>
