{% extends "base.html" %}
{% block title %}ZetaConvert · Conversor de archivos online{% endblock %}
{% block meta_desc %}Convertí imágenes, video, 3D y documentos en segundos. Gratis, simple y privado.{% endblock %}

{% block hero %}
<section class="hero">
  <div class="container">
    <h1>Conversión de archivos profesional</h1>
    <p class="muted">Imágenes, video, 3D y documentos. Sin registro. Resultados rápidos y privados.</p>

    <!-- Buscador con resultados flotantes -->
    <div class="searchbox mt-2" role="search">
      <input id="formatSearch" class="search-input" type="text" placeholder="Buscar formato o tarea (ej: heic, mp4, unir pdf)" aria-label="Buscar formato o tarea" autocomplete="off">
      <button id="clearSearch" class="btn compact" type="button" aria-label="Limpiar búsqueda">Limpiar</button>

      <!-- popover -->
      <div id="searchPopover" class="popover" role="listbox" aria-label="Resultados de búsqueda" aria-expanded="false" hidden>
        <div id="searchList" class="popover-list"></div>
        <div class="popover-foot"><small id="searchCount" class="muted"></small></div>
      </div>
    </div>

    <!-- Tabs categorías -->
    <div class="cat-tabs" role="tablist" aria-label="Categorías">
      <button class="cat-tab active" data-cat="imagenes" role="tab" aria-selected="true">Imágenes</button>
      <button class="cat-tab" data-cat="video" role="tab" aria-selected="false">Video</button>
      <button class="cat-tab" data-cat="3d" role="tab" aria-selected="false">3D</button>
      <button class="cat-tab" data-cat="documentos" role="tab" aria-selected="false">Documentos</button>
    </div>
  </div>
</section>
{% endblock %}

{% block content %}
<section class="container">
  <!-- Panel: Imágenes -->
  <section class="panel section-accent cat-panel show" id="panel-imagenes" aria-labelledby="tab-imagenes" role="tabpanel">
    <div class="panel-head">
      <h2>Imágenes</h2>
      <p class="muted">Conversiones más usadas para web y móvil.</p>
    </div>
    <div class="cards">
      {% for r in routes_list if r.category == 'imagenes' %}
      <a class="card"
   href="{{ url_for('route_page', slug=r.slug) }}"
   data-slug="{{ r.slug }}"
   data-cat="{{ r.category }}"
   data-from="{{ (r.exts_from or [])|join(',') }}"
   data-to="{{ (r.exts_to or [])|join(',') }}">
 href="{{ url_for('route_page', slug=r.slug) }}">
        <strong class="card-title">{{ r.title }}</strong>
        <p class="muted">{{ r.desc }}</p>
        {% if r.exts_from or r.exts_to %}
        <div class="meta">
          {% if r.exts_from %}<span class="badge">de: {{ ', '.join(r.exts_from) }}</span>{% endif %}
          {% if r.exts_to %}<span class="badge">a: {{ ', '.join(r.exts_to) }}</span>{% endif %}
        </div>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </section>

  <!-- Panel: Video -->
  <section class="panel section-accent cat-panel" id="panel-video" aria-labelledby="tab-video" role="tabpanel" hidden>
    <div class="panel-head">
      <h2>Video</h2>
      <p class="muted">Extracción de audio y conversiones compatibles.</p>
    </div>
    <div class="cards">
      {% for r in routes_list if r.category == 'video' %}
      <a class="card"
   href="{{ url_for('route_page', slug=r.slug) }}"
   data-slug="{{ r.slug }}"
   data-cat="{{ r.category }}"
   data-from="{{ (r.exts_from or [])|join(',') }}"
   data-to="{{ (r.exts_to or [])|join(',') }}">
 href="{{ url_for('route_page', slug=r.slug) }}">
        <strong class="card-title">{{ r.title }}</strong>
        <p class="muted">{{ r.desc }}</p>
        {% if r.exts_from or r.exts_to %}
        <div class="meta">
          {% if r.exts_from %}<span class="badge">de: {{ ', '.join(r.exts_from) }}</span>{% endif %}
          {% if r.exts_to %}<span class="badge">a: {{ ', '.join(r.exts_to) }}</span>{% endif %}
        </div>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </section>

  <!-- Panel: 3D -->
  <section class="panel section-accent cat-panel" id="panel-3d" aria-labelledby="tab-3d" role="tabpanel" hidden>
    <div class="panel-head">
      <h2>3D</h2>
      <p class="muted">Conversión de mallas y formatos CAD frecuentes.</p>
    </div>
    <div class="cards">
      {% for r in routes_list if r.category == '3d' %}
      <a class="card"
   href="{{ url_for('route_page', slug=r.slug) }}"
   data-slug="{{ r.slug }}"
   data-cat="{{ r.category }}"
   data-from="{{ (r.exts_from or [])|join(',') }}"
   data-to="{{ (r.exts_to or [])|join(',') }}">
 href="{{ url_for('route_page', slug=r.slug) }}">
        <strong class="card-title">{{ r.title }}</strong>
        <p class="muted">{{ r.desc }}</p>
        {% if r.exts_from or r.exts_to %}
        <div class="meta">
          {% if r.exts_from %}<span class="badge">de: {{ ', '.join(r.exts_from) }}</span>{% endif %}
          {% if r.exts_to %}<span class="badge">a: {{ ', '.join(r.exts_to) }}</span>{% endif %}
        </div>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </section>

  <!-- Panel: Documentos -->
  <section class="panel section-accent cat-panel" id="panel-documentos" aria-labelledby="tab-documentos" role="tabpanel" hidden>
    <div class="panel-head">
      <h2>Documentos</h2>
      <p class="muted">Herramientas PDF y conversiones Office.</p>
    </div>
    <div class="cards">
      {% for r in routes_list if r.category == 'documentos' %}
      <a class="card"
   href="{{ url_for('route_page', slug=r.slug) }}"
   data-slug="{{ r.slug }}"
   data-cat="{{ r.category }}"
   data-from="{{ (r.exts_from or [])|join(',') }}"
   data-to="{{ (r.exts_to or [])|join(',') }}">
 href="{{ url_for('route_page', slug=r.slug) }}">
        <strong class="card-title">{{ r.title }}</strong>
        <p class="muted">{{ r.desc }}</p>
        {% if r.exts_from or r.exts_to %}
        <div class="meta">
          {% if r.exts_from %}<span class="badge">de: {{ ', '.join(r.exts_from) }}</span>{% endif %}
          {% if r.exts_to %}<span class="badge">a: {{ ', '.join(r.exts_to) }}</span>{% endif %}
        </div>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </section>
</section>
<script>
  window.ZCFMT = {
    map: "{{ url_for('static', path='formats.map.json') }}",
    status: "{{ url_for('static', path='formats.status.json') }}"
  };
</script>

<!-- JS: tabs + buscador popover -->
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const $  = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  
    async function getJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error(url+' '+r.status);
      return r.json();
    }
  
    // Tabs
    const tabs = [...document.querySelectorAll('.cat-tab')];
    const panels = {
      'imagenes': document.getElementById('panel-imagenes'),
      'video': document.getElementById('panel-video'),
      '3d': document.getElementById('panel-3d'),
      'documentos': document.getElementById('panel-documentos')
    };
    function show(cat){
      tabs.forEach(t=>{ const on = t.dataset.cat===cat; t.classList.toggle('active', on); t.setAttribute('aria-selected', on?'true':'false'); });
      Object.entries(panels).forEach(([k,el])=>{
        const on = (k===cat); el.toggleAttribute('hidden', !on); el.classList.toggle('show', on);
      });
    }
    tabs.forEach(t=>t.addEventListener('click', ()=>show(t.dataset.cat)));
  
    // Dataset buscador (compat backend)
    let routes = [];
    try {
      const j = await getJSON('/formats.json');
      routes = Array.isArray(j?.items) ? j.items : [];
    } catch(e) { console.warn('formats.json falló', e); }
  
    // Carga mapa + status (con fallback a “no filtrar”)
    let fmtMap = { extToId:{}, idToFmt:{} };
    let enabledSet = new Set();
    let filterActive = true;
  
    try {
      const mapUrl = (window.ZCFMT?.map)    || '/static/formats.map.json';
      const stUrl  = (window.ZCFMT?.status) || '/static/formats.status.json';
      const [mapJson, stJson] = await Promise.all([ getJSON(mapUrl), getJSON(stUrl) ]);
  
      const extToId = {};
      const idToFmt = {};
      Object.values(mapJson?.categories || {}).forEach(arr => {
        arr.forEach(f => {
          if (f?.ext && f?.id) extToId[f.ext.toLowerCase()] = f.id;
          if (f?.id) idToFmt[f.id] = f;
        });
      });
      (stJson?.status || []).forEach(s => { if (s?.id && s.enabled === true) enabledSet.add(s.id); });
  
      fmtMap = { extToId, idToFmt };
  
      // si no hay NINGUNO habilitado, no ocultamos nada
      if (enabledSet.size === 0) {
        console.warn('formats.status.json sin habilitados → no se filtra');
        filterActive = false;
      }
    } catch (e) {
      console.warn('No se pudo cargar formats.map/status → no se filtra', e);
      filterActive = false;
    }
  
    // Helpers de decisión (respetan filterActive)
    const isExtEnabled = (ext) => {
      if (!filterActive) return true;
      const id = fmtMap.extToId[ext?.toLowerCase?.() || ''];
      return !!(id && enabledSet.has(id));
    };
  
    function enabledTargetsFromExt(ext){
      if (!filterActive) return []; // no se limita en buscador si no hay filtro
      const id  = fmtMap.extToId[ext?.toLowerCase?.() || ''];
      const fmt = id && fmtMap.idToFmt[id];
      if (!fmt) return [];
      const out = [];
      (fmt.targets || []).forEach(tid=>{
        if (enabledSet.has(tid)) {
          const tf = fmtMap.idToFmt[tid];
          if (tf?.ext) out.push(tf.ext.toLowerCase());
        }
      });
      return out;
    }
  
    function routeIsViable(route){
      if (!filterActive) return true;
      const fromOk = (route.from||[]).some(isExtEnabled);
      if (!fromOk) return false;
  
      const allTargets = new Set();
      (route.from||[]).forEach(ext=> enabledTargetsFromExt(ext).forEach(t=>allTargets.add(t)));
      if (allTargets.size === 0) return false;
  
      if ((route.to||[]).length === 0) return true;
      const declared = route.to.map(x=>x.toLowerCase());
      return declared.some(t => allTargets.has(t));
    }
  
    function deriveAllowedTargets(route){
      if (!filterActive) return route.to || [];
      const allowed = new Set();
      (route.from||[]).forEach(ext=> enabledTargetsFromExt(ext).forEach(t=>allowed.add(t)));
      const out = Array.from(allowed);
      if ((route.to||[]).length) {
        const declared = new Set(route.to.map(x=>x.toLowerCase()));
        return out.filter(t=>declared.has(t));
      }
      return out;
    }
  
    // Buscador con filtro
    const filteredRoutes = (filterActive ? routes.filter(routeIsViable) : routes)
                            .map(r => ({ ...r, to: deriveAllowedTargets(r) }));
  
    const input   = $('#formatSearch');
    const clearBt = $('#clearSearch');
    const pop     = $('#searchPopover');
    const list    = $('#searchList');
    const count   = $('#searchCount');
  
    function closePop(){ pop.hidden = true; pop.setAttribute('aria-expanded','false'); }
    function openPop(){ pop.hidden = false; pop.setAttribute('aria-expanded','true'); }
  
    function render(items){
      list.innerHTML = '';
      count.textContent = items.length ? (items.length + ' resultado' + (items.length>1?'s':'')) : 'Sin resultados';
      items.slice(0, 20).forEach(it=>{
        const a = document.createElement('a');
        a.className = 'popover-item';
        a.href = '/r/' + it.slug;
        const meta = [];
        if (it.from?.length) meta.push('de: ' + it.from.join(', '));
        if (it.to?.length)   meta.push('a: ' + it.to.join(', '));
        a.innerHTML = `<div class="pi-title">${it.title}</div><div class="pi-meta">${meta.join(' · ')}</div>`;
        list.appendChild(a);
      });
    }
  
    function search(){
      const q = input.value.trim().toLowerCase();
      if(!q){ closePop(); return; }
      const hay = (d)=>[d.title,d.desc,d.category, ...(d.from||[]), ...(d.to||[]), ...(d.keywords||[])]
                      .join(' ').toLowerCase();
      const out = filteredRoutes.filter(d=> hay(d).includes(q));
      render(out); openPop();
    }
  
    input.addEventListener('input', search);
    input.addEventListener('focus', ()=>{ if(input.value.trim()) openPop(); });
    document.addEventListener('click', (e)=>{ if(!e.target.closest('.searchbox')) closePop(); });
    clearBt.addEventListener('click', ()=>{ input.value=''; closePop(); input.focus(); });
  
    // Ocultar cards no viables (solo si el filtro está activo)
    if (filterActive) {
      $$('.card[data-from]').forEach(card=>{
        const from = (card.getAttribute('data-from')||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
        const to   = (card.getAttribute('data-to')  ||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
        const fakeRoute = { from, to };
        if (!routeIsViable(fakeRoute)) {
          card.style.display = 'none';
        } else {
          const allowed = deriveAllowedTargets(fakeRoute);
          // Actualiza badge “a: …” si existe
          const badges = card.querySelectorAll('.badge');
          const badgeTo = badges.length >= 2 ? badges[1] : null;
          if (badgeTo && allowed.length) badgeTo.textContent = 'a: ' + allowed.join(', ');
        }
      });
    }
  });
  </script>
  
  
{% endblock %}
