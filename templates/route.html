{% extends "base.html" %}

{% block title %}{{ page_title }} · ZetaConvert{% endblock %}
{% block meta_desc %}{{ page_desc }}{% endblock %}
{% block og_title %}{{ page_title }}{% endblock %}
{% block og_desc %}{{ page_desc }}{% endblock %}
<section class="hero">
  <nav aria-label="migas" class="hint"><a href="{{ url_for('home') }}">Inicio</a> › <span>{{ page_title }}</span></nav>
  <h1>{{ page_title }}</h1>
  <p class="muted">{{ page_desc }}</p>
</section>
{% endblock %}
{% block content %}
<section class="panel section-accent">
<section class="panel converter">
  <h2>Subí tu archivo</h2>
  <form id="convertForm" action="/api/convert" method="post" enctype="multipart/form-data">
    <div class="panel-head">
      <h1 class="h-title">{{ route.title }}</h1>
    
      <div class="format-switch">
        <label for="formatSwitch" class="sr-only">Cambiar conversión</label>
        <select id="formatSwitch" class="select">
          {# 1) Priorizamos herramientas que comparten el mismo "from" #}
          <optgroup label="Relacionados">
            {% set current_from = route.exts_from or [] %}
            {% for r in routes_list %}
              {% if r.slug != route.slug and (r.exts_from|length > 0) and (current_from|length > 0)
                    and (r.exts_from|select('in', current_from)|list|length > 0) %}
                <option value="{{ url_for('route_page', slug=r.slug) }}">{{ r.title }}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
    
          {# 2) Todos los demás #}
          <optgroup label="Todos los conversores">
            {% for r in routes_list %}
              {% if r.slug != route.slug %}
                <option value="{{ url_for('route_page', slug=r.slug) }}">{{ r.title }}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
        </select>
      </div>
    </div>
    
    <input type="hidden" name="route" value="{{ route.slug }}">
    <div class="grid2">
      <div>
        <label for="file">Archivo</label>
        <input id="file" name="file{% if route.multi %}s{% endif %}" type="file" {% if route.multi %}multiple{% endif %} accept="{{ route.accept }}" required>
      </div>
      <div>
        <label for="target">Convertir a:</label>

<select id="target"
        name="target"
        required
        data-route-template="{{ url_for('route_page', slug='__SLUG__') }}"
        data-current-slug="{{ route.slug }}"
        style="text-transform: uppercase;">
  {% for t in all_targets %}
    <option
      value="{{ t }}"
      data-slug="{{ target_to_slug.get(t, '') }}"
      {% if route.to and (t == route.to[0]) %}selected{% endif %}>
      {{ t }}
    </option>
  {% endfor %}
</select>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var sel = document.getElementById('target');
  if (!sel) return;

  var currentSlug = sel.getAttribute('data-current-slug');
  var routeTpl    = sel.getAttribute('data-route-template');

  sel.addEventListener('change', function () {
    var opt  = sel.options[sel.selectedIndex];
    var slug = opt.getAttribute('data-slug');     // a qué conversor ir para ese target

    if (slug && slug !== currentSlug) {
      var next = routeTpl.replace('__SLUG__', slug);
      window.location.href = next;
      return;
    }
    // Si no cambia de slug, la ruta actual soporta el target: submit normal del form.
  });
});
</script>


      </div>
    </div>

    <details class="expander mt-2"><summary>Opciones avanzadas</summary>
      <div class="grid3 mt-1">
        <label>Calidad (JPG/WEBP)<input type="range" name="quality" min="50" max="100" value="90" step="1"></label>
        <label>DPI (PDF→imagen)<input type="number" name="dpi" min="72" max="300" value="144"></label>
        <label>Páginas (PDF)<input type="text" name="pages" placeholder="1-3,5"></label>
      </div>
      <div class="grid3 mt-1">
        <label>Ancho (px)<input type="number" name="resize_w" min="0" value="0"></label>
        <label>Alto (px)<input type="number" name="resize_h" min="0" value="0"></label>
        <label class="chk"><input type="checkbox" name="stripmeta" value="1" checked> Quitar metadatos</label>
      </div>
      <label class="chk"><input id="precompress" type="checkbox"> Optimizar en el navegador antes de subir</label>
    </details>

    <button class="btn primary" type="submit" data-animate="press">Convertir</button>
    <div class="progress mt-2" role="progressbar" aria-label="Progreso"><div class="bar" id="progressBar"></div></div>
  </form>
  <script>
    (function(){
      // Datos enviados por backend como strings JSON seguros:
      const TARGET_TO_SLUG = JSON.parse('{{ target_to_slug_json | e }}');
      const ALL_TARGETS = JSON.parse('{{ all_targets_json | e }}');
  
      // Rellenar el <select id="target">
      const sel = document.getElementById('target');
      if (sel && ALL_TARGETS.length) {
        const currentVal = sel.value?.toLowerCase();
        sel.innerHTML = "";
        ALL_TARGETS.forEach(fmt => {
          const opt = document.createElement('option');
          opt.value = fmt;
          opt.textContent = fmt.toUpperCase();
          sel.appendChild(opt);
        });
        // Mantener si existía
        if (currentVal && ALL_TARGETS.includes(currentVal)) {
          sel.value = currentVal;
        }
      }
  
      // Redirección al cambiar de formato: /r/{slug-asociado}
      // Mantiene el archivo ya cargado? No: es redirección. UX estándar como Convertio.
      if (sel) {
        sel.addEventListener('change', (e) => {
          const fmt = e.target.value.toLowerCase();
          const slug = TARGET_TO_SLUG[fmt];
          if (slug) {
            const base = location.origin;
            location.href = base + '/r/' + slug;
          }
        });
      }
    })();
  </script>
  
  <details class="expander mt-2">
    <summary>Beneficios</summary>
    <ul class="benefits"><li>Rápido</li><li>Privado</li><li>Gratis</li><li>Compatible</li></ul>
  </details>
</section>
</section>

<section class="panel">
  <h2>Pasos</h2>
  <ol><li>Elegí o arrastrá tus archivos.</li><li>Seleccioná el formato.</li><li>Convertí.</li><li>Descargá.</li></ol>
</section>

<script type="application/ld+json">
{"@context":"https://schema.org","@type":"HowTo","name":"{{ page_title }}","description":"{{ page_desc }}",
 "step":[{"@type":"HowToStep","name":"Subir archivo","text":"Elegí o arrastrá tus archivos."},
         {"@type":"HowToStep","name":"Elegir formato","text":"Seleccioná el formato de salida."},
         {"@type":"HowToStep","name":"Convertir","text":"Hacé clic en Convertir."},
         {"@type":"HowToStep","name":"Descargar","text":"Descargá el resultado."}]}
</script>

<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BreadcrumbList",
 "itemListElement":[
  {"@type":"ListItem","position":1,"name":"Inicio","item":"https://zetaconvert.online/"},
  {"@type":"ListItem","position":2,"name":"{{ page_title }}","item":"https://zetaconvert.online{{ request.url.path }}"}
 ]}
</script>
{% endblock %}

{% block extra_head %}
  <link rel="canonical" href="{{ request.url }}">
  <!-- BreadcrumbList -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Inicio","item":"https://zetaconvert.online/"},
      {"@type":"ListItem","position":2,"name":"Herramientas","item":"https://zetaconvert.online/routes"},
      {"@type":"ListItem","position":3,"name":"{{ route.title }}","item":"{{ request.url }}"}
    ]
  }
  </script>
  <!-- FAQPage: ajustá preguntas si querés -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {
        "@type":"Question",
        "name":"¿Cómo convierto {{ route.title|lower }}?",
        "acceptedAnswer":{"@type":"Answer","text":"Subí tu archivo, elegí el formato destino y hacé clic en Convertir. En segundos descargás el resultado."}
      },
      {
        "@type":"Question",
        "name":"¿Se mantiene la calidad?",
        "acceptedAnswer":{"@type":"Answer","text":"Optimizamos para equilibrio entre calidad y tamaño. Podés ajustar calidad/DPI cuando corresponda."}
      },
      {
        "@type":"Question",
        "name":"¿Mis archivos son privados?",
        "acceptedAnswer":{"@type":"Answer","text":"Los archivos se procesan de forma temporal y se eliminan automáticamente del servidor tras la descarga."}
      }
    ]
  }
  </script>
{% endblock %}

{% block hero %}
<section class="hero">
  <h1>{{ route.title }}</h1>
  <p class="muted">{{ route.desc }} Gratis y sin registro.</p>
</section>
{% endblock %}

{% block content %}
<!-- tu formulario y UI actual del conversor acá -->
{% endblock %}