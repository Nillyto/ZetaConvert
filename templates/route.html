{% extends "base.html" %}

{% block title %}{{ page_title }} · ZetaConvert{% endblock %}
{% block meta_desc %}{{ page_desc }}{% endblock %}
{% block og_title %}{{ page_title }}{% endblock %}
{% block og_desc %}{{ page_desc }}{% endblock %}

{% block hero %}
<section class="hero">
  <nav aria-label="breadcrumbs" class="hint">
    <a href="{{ url_for('home') }}">Inicio</a> › <span>{{ page_title }}</span>
  </nav>
  <h1>{{ page_title }}</h1>
  <p class="muted">{{ page_desc }}</p>
</section>
{% endblock %}

{% block content %}
<section class="panel converter section-accent">
  <div class="panel-head">
    <h2 class="h-title">{{ route.title }}</h2>

    <div class="format-switch">
      <label for="formatSwitch" class="sr-only">Cambiar conversión</label>
      <select id="formatSwitch" class="select">
        <optgroup label="Relacionados">
          {% set current_from = route.exts_from or [] %}
          {% for r in routes_list %}
            {% if r.slug != route.slug and (r.exts_from|length > 0) and (current_from|length > 0)
                  and (r.exts_from|select('in', current_from)|list|length > 0) %}
              <option value="{{ url_for('route_page', slug=r.slug) }}">{{ r.title }}</option>
            {% endif %}
          {% endfor %}
        </optgroup>
        <optgroup label="Todos los conversores">
          {% for r in routes_list if r.slug != route.slug %}
            <option value="{{ url_for('route_page', slug=r.slug) }}">{{ r.title }}</option>
          {% endfor %}
        </optgroup>
      </select>
    </div>
  </div>

  <form id="convertForm" action="/api/convert" method="post" enctype="multipart/form-data">
    <input type="hidden" name="route" value="{{ route.slug }}">

    <div class="grid2">
      <div>
        <label for="file">Archivo</label>
        <input id="file"
               name="file{% if route.multi %}s{% endif %}"
               type="file"
               {% if route.multi %}multiple{% endif %}
               accept="{{ route.accept }}"
               required>
      </div>

      <div>
        <label for="target">Convertir a</label>
        <select id="target" name="target" required style="text-transform: uppercase;"></select>
      </div>
    </div>

    <details class="expander mt-2">
      <summary>Opciones avanzadas</summary>
      <div class="grid3 mt-1">
        <label>Calidad (JPG/WEBP)
          <input type="range" name="quality" min="50" max="100" value="90" step="1">
        </label>
        <label>DPI (PDF→imagen)
          <input type="number" name="dpi" min="72" max="300" value="144">
        </label>
        <label>Páginas (PDF)
          <input type="text" name="pages" placeholder="1-3,5">
        </label>
      </div>
      <div class="grid3 mt-1">
        <label>Ancho (px)
          <input type="number" name="resize_w" min="0" value="0">
        </label>
        <label>Alto (px)
          <input type="number" name="resize_h" min="0" value="0">
        </label>
        <label class="chk">
          <input type="checkbox" name="stripmeta" value="1" checked> Quitar metadatos
        </label>
      </div>
      <label class="chk">
        <input id="precompress" type="checkbox"> Optimizar en el navegador antes de subir
      </label>
    </details>

    <button class="btn primary" type="submit" data-animate="press">Convertir</button>
    <div class="progress mt-2" role="progressbar" aria-label="Progreso">
      <div class="bar" id="progressBar"></div>
    </div>
  </form>
</section>

<section class="panel">
  <h2>Pasos</h2>
  <ol>
    <li>Elegí o arrastrá tus archivos.</li>
    <li>Seleccioná el formato.</li>
    <li>Convertí.</li>
    <li>Descargá.</li>
  </ol>
</section>

{# ===== JSON seguro inyectado por backend ===== #}
<script type="application/json" id="targets-json">{{ all_targets_json | safe }}</script>
<script type="application/json" id="map-json">{{ target_to_slug_json | safe }}</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // llenar el <select id="target"> desde JSON seguro
  const targetsEl = document.getElementById('targets-json');
  const mapEl     = document.getElementById('map-json');
  if (!targetsEl || !mapEl) return;

  let ALL_TARGETS = [];
  let TARGET_TO_SLUG = {};
  try {
    ALL_TARGETS = JSON.parse(targetsEl.textContent || "[]");
    TARGET_TO_SLUG = JSON.parse(mapEl.textContent || "{}");
  } catch (e) { console.error('JSON inválido', e); }

  const sel = document.getElementById('target');
  if (!sel) return;

  // poblar
  sel.innerHTML = "";
  ALL_TARGETS.forEach(fmt => {
    const opt = document.createElement('option');
    opt.value = fmt;
    opt.textContent = fmt.toUpperCase();
    sel.appendChild(opt);
  });

  // seleccionar por defecto el primero de la ruta actual
  const defaultTarget = "{{ (route.to[0] if route.to else '') | e }}";
  if (defaultTarget) {
    sel.value = defaultTarget;
  }

  // si el target apunta a otro conversor, redirigir
  sel.addEventListener('change', () => {
    const t = sel.value.toLowerCase();
    const slug = TARGET_TO_SLUG[t];
    const currentSlug = "{{ route.slug }}";
    if (slug && slug !== currentSlug) {
      window.location.assign("{{ url_for('route_page', slug='__SLUG__') }}".replace("__SLUG__", slug));
    }
  });

  // combo “Relacionados / Todos los conversores”
  const switcher = document.getElementById('formatSwitch');
  if (switcher) {
    switcher.addEventListener('change', () => {
      const url = switcher.value;
      if (url) window.location.assign(url);
    });
  }
});
</script>

{# HowTo para SEO #}
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"HowTo",
  "name":"{{ page_title }}",
  "description":"{{ page_desc }}",
  "step":[
    {"@type":"HowToStep","name":"Subir archivo","text":"Elegí o arrastrá tus archivos."},
    {"@type":"HowToStep","name":"Elegir formato","text":"Seleccioná el formato de salida."},
    {"@type":"HowToStep","name":"Convertir","text":"Hacé clic en Convertir."},
    {"@type":"HowToStep","name":"Descargar","text":"Descargá el resultado."}
  ]
}
</script>
{% endblock %}
