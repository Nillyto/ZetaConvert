{% extends "base.html" %}

{% block title %}{{ page_title }} · ZetaConvert{% endblock %}
{% block meta_desc %}{{ page_desc }}{% endblock %}
{% block og_title %}{{ page_title }}{% endblock %}
{% block og_desc %}{{ page_desc }}{% endblock %}

{% block hero %}
<section class="hero">
  <nav aria-label="breadcrumbs" class="hint">
    <a href="{{ url_for('home') }}">Inicio</a> › <span>{{ page_title }}</span>
  </nav>
  <h1>{{ page_title }}</h1>
  <p class="muted">{{ page_desc }}</p>
</section>
{% endblock %}

{% block content %}
<section class="panel converter" id="zcConverter" aria-label="Conversor de archivos">
  <div class="panel-head">
    <div>
      <h2 class="h-title">{{ route.title }}</h2>
      <p class="muted">{{ route.desc }} Gratis y sin registro.</p>
    </div>

    <!-- Formato de salida (global) con redirección inteligente -->
    <div>
      <label for="globalTarget" class="sr-only">Formato de salida</label>
      <select id="globalTarget"
              class="select"
              data-route-template="{{ url_for('route_page', slug='__SLUG__') }}"
              data-current-slug="{{ route.slug }}"
              style="text-transform: uppercase;">
        {% for t in all_targets %}
          <option value="{{ t }}"
                  data-slug="{{ target_to_slug.get(t, '') }}"
                  {% if route.to and (t == route.to[0]) %}selected{% endif %}>
            {{ t }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Zona de drop + botón -->
  <div id="dropZone" class="dropzone" role="button" tabindex="0" aria-label="Soltá aquí tus archivos o hacé clic para seleccionar">
    <strong>Soltá tus archivos aquí</strong>
    <span class="muted">o hacé clic para seleccionar (máx. 5)</span>
    <input id="fileInput" type="file" hidden
           {% if route.multi %}multiple{% else %}multiple{% endif %}
           accept="{{ route.accept }}">
  </div>

  <!-- Cola -->
  <div id="fileQueue" class="queue" aria-live="polite"></div>

  <!-- Acciones -->
  <div class="actions mt-2">
    <button id="btnAdd" class="btn">Agregar archivos</button>
    <button id="btnConvertAll" class="btn primary">Convertir todo</button>
    <button id="btnClear" class="btn" type="button">Limpiar</button>
  </div>

  <!-- Progreso global -->
  <div class="progress mt-2" role="progressbar" aria-label="Progreso total">
    <div class="bar" id="overallBar" style="width:0%"></div>
  </div>
</section>

<section class="panel">
  <h2>Pasos</h2>
  <ol>
    <li>Elegí o arrastrá tus archivos.</li>
    <li>Seleccioná el formato.</li>
    <li>Convertí.</li>
    <li>Descargá.</li>
  </ol>
</section>

{# ===== JSON seguro inyectado por backend ===== #}
<script id="targets-json" type="application/json">
  {{ all_targets|tojson }}
  </script>
  <script id="map-json" type="application/json">
  {{ target_to_slug|tojson }}
  </script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // llenar el <select id="target"> desde JSON seguro
  const targetsEl = document.getElementById('targets-json');
  const mapEl     = document.getElementById('map-json');
  if (!targetsEl || !mapEl) return;

  let ALL_TARGETS = [];
  let TARGET_TO_SLUG = {};
  try {
    ALL_TARGETS = JSON.parse(targetsEl.textContent || "[]");
    TARGET_TO_SLUG = JSON.parse(mapEl.textContent || "{}");
  } catch (e) { console.error('JSON inválido', e); }

  const sel = document.getElementById('target');
  if (!sel) return;

  // poblar
  sel.innerHTML = "";
  ALL_TARGETS.forEach(fmt => {
    const opt = document.createElement('option');
    opt.value = fmt;
    opt.textContent = fmt.toUpperCase();
    sel.appendChild(opt);
  });

  // seleccionar por defecto el primero de la ruta actual
  const defaultTarget = "{{ (route.to[0] if route.to else '') | e }}";
  if (defaultTarget) {
    sel.value = defaultTarget;
  }

  // si el target apunta a otro conversor, redirigir
  sel.addEventListener('change', () => {
    const t = sel.value.toLowerCase();
    const slug = TARGET_TO_SLUG[t];
    const currentSlug = "{{ route.slug }}";
    if (slug && slug !== currentSlug) {
      window.location.assign("{{ url_for('route_page', slug='__SLUG__') }}".replace("__SLUG__", slug));
    }
  });

  // combo “Relacionados / Todos los conversores”
  const switcher = document.getElementById('formatSwitch');
  if (switcher) {
    switcher.addEventListener('change', () => {
      const url = switcher.value;
      if (url) window.location.assign(url);
    });
  }
});
</script>

{# HowTo para SEO #}
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"HowTo",
  "name":"{{ page_title }}",
  "description":"{{ page_desc }}",
  "step":[
    {"@type":"HowToStep","name":"Subir archivo","text":"Elegí o arrastrá tus archivos."},
    {"@type":"HowToStep","name":"Elegir formato","text":"Seleccioná el formato de salida."},
    {"@type":"HowToStep","name":"Convertir","text":"Hacé clic en Convertir."},
    {"@type":"HowToStep","name":"Descargar","text":"Descargá el resultado."}
  ]
}
</script>
{% endblock %}
